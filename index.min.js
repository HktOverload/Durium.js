export class Station{static reg={};static next_id_RAW=0;subscribers;_source;id;constructor(){this.id=Station.getNextId(),this.subscribers=[],Station.reg[this.id]=this}static getNextId(){return Station.next_id_RAW+=1,Station.next_id_RAW}_fire(t){let e;e=void 0!==t?t:this._source();for(const t of this.subscribers)t(e)}subscribe(t){this.subscribers.push(t)}get source(){return new StationSource(this.id)}get fire(){return new StationFiring(this.id)}map(t){let e=new Station;return e._source=()=>t(this._source()),this.subscribe((i=>{e._fire(t(i))})),e}proxy(){let t=new Station;return t._source=()=>this._source(),this.subscribe((e=>{t._fire(e)})),t}filter(t){let e=new Station;return e._source=()=>this._source(),this.subscribe((i=>{t(i)&&e._fire(i)})),e}reject(t){let e=new Station;return e._source=()=>this._source(),this.subscribe((i=>{t(i)||e._fire(i)})),e}filterValue(t){return this.filter((e=>e===t))}rejectValue(t){return this.filter((e=>e!==t))}scan(t,e){let i=new Station,n={__state:t};return i._source=()=>n.__state,this.subscribe((t=>{n.__state=e(n.__state,t),i._fire()})),i}history({reverse:t=!1}={}){return t?this.scan([],((t,e)=>[e,...t])):this.scan([],((t,e)=>[...t,e]))}static scanMulti(t,...e){let i=new Station,n={__state:t};i._source=()=>n.__state;for(const[t,o]of e)t.subscribe((t=>{n.__state=o(n.__state,t),i._fire()}));return i}get fireElement(){return new StationElementFiring(this.id)}}class StationSource{station_id;constructor(t){this.station_id=t}bindTo(t){Station.reg[this.station_id]._source=t}bindToElementAttribute(t,e){this.bindTo((()=>document.getElementById(t)[e]))}}class StationFiring{station_id;constructor(t){this.station_id=t}toJs(){return`du_f_(${this.station_id})`}}class StationElementFiring{station_id;constructor(t){this.station_id=t}idToJs(t){return`du_fe_(${this.station_id}, '${t}')`}}const to_html_memo=new WeakMap,to_html_given_memo=new WeakMap,void_elements=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"];class DuNode{static next_id_RAW=0;tag;is_void_element;attrs;inner;suffix;id;constructor(t,e,i){this.tag=t,this.is_void_element=void_elements.includes(t),this.attrs=Object.entries(e),this.inner=i,this.id=null}static getNextId(){return DuNode.next_id_RAW+=1,DuNode.next_id_RAW}getHtmlId(){return`~du${this.id}`}getElement(){return document.getElementById(this.getHtmlId())}toHtmlGivenTransform(t){this.id=DuNode.getNextId();let e,i=this.getHtmlId(),n=this.attrs.map((([t,e])=>{if(e instanceof StationSource)return e.bindToElementAttribute(i,t),null;if(e instanceof StationFiring)return[t,e.toJs()];if(e instanceof StationElementFiring){return Station.reg[e.station_id]._source=()=>this.getElement(),[t,e.idToJs(i)]}return[t,e]})).filter((t=>null!==t)).map((([t,e])=>`${t}="${e}"`)).join(" ");if(null!==i&&(n+=` id="${i}"`),this.is_void_element)e=`<${this.tag} ${n}>`;else{let i=this.inner.map(t).join("");e=`<${this.tag} ${n}>${i}</${this.tag}>`}return e}toHtml(){return this.toHtmlGivenTransform((t=>toHtmlFunction(t)))}toHtmlGiven(t){return this.toHtmlGivenTransform((e=>(this.id=DuNode.getNextId(),toHtmlGivenFunction(e,t))))}}class Layout{inner;constructor(...t){this.inner=du.div(...t)}of(t){return new LayoutNode(t,this.inner)}}class LayoutNode{station;inner;id;static loaded_stations={};static next_id_RAW=0;constructor(t,e){this.station=t.proxy(),this.inner=e,this.id=LayoutNode.getNextId()}static getNextId(){return this.next_id_RAW+=1,this.next_id_RAW}toHtml(){let t=`du_genLayoutNode-div-${this.id}`,e=`<div id="${t}"></div>`;return this.station.subscribe((e=>{let i=document.getElementById(t);void 0!==i&&(i.innerHTML=this.inner.toHtmlGiven(e))})),LayoutNode.loaded_stations[this.id]=this.station,e}}function isNodeObject(t){return void 0!==t.toHtml||void 0!==t.toHtmlGiven}export var du=function(t,...e){let i,n;return"object"!=typeof e[0]||isNodeObject(e[0])?(i={},n=e):(i=e[0],n=e.slice(1)),new DuNode(t,i,n)};var du_has_he=void 0;function encodeHtml(t){if(du_has_he)return he.encode(t);if(!1===du_has_he){let e=document.createElement("textarea");return e.textContent=t,e.innerHTML}return du_has_he=!(!window.he||!window.he.encode),encodeHtml(t)}function du_value(){return{toHtmlGiven:t=>encodeHtml(t)}}function du_prop(t){return{toHtmlGiven:e=>encodeHtml(e[t])}}function toHtmlGivenFunction(t,e){if("string"==typeof t)return encodeHtml(t);let i;if(to_html_given_memo.has(t)){if(i=to_html_given_memo.get(t),i.has(e))return to_html_given_memo.get(t).get(e)}else i=new Map,to_html_given_memo.set(t,i);let n=t.toHtmlGiven(e);return i.set(e,n),n}function toHtmlFunction(t){if("string"==typeof t)return encodeHtml(t);if(to_html_memo.has(t))return to_html_memo.get(t);let e=t.toHtml();return to_html_memo.set(t,e),e}function du_section(t,...e){return{toHtmlGiven:i=>{let n=e.map((e=>toHtmlGivenFunction(e,i[t])));return`<div class="du_gen-section_${t}">${n.join("")}</div>`}}}function du_repeat(...t){return{toHtmlGiven:e=>`<div class="du_gen-repeat">${e.flatMap((e=>t.map((t=>toHtmlGivenFunction(t,e))))).join("")}</div>`}}function du_opt(...t){return{toHtmlGiven:e=>{if(null!==e){return`<div class="du_gen-opt_nonnull">${t.map((t=>toHtmlGivenFunction(t,e))).join("")}</div>`}return'<div class="du_gen-opt_null"></div>'}}}function du_div(...t){return du("div",...t)}function du_layout(...t){return new Layout(...t)}function du_mount(t,e){mount_durium_component(t,e)}du.value=du_value,du.prop=du_prop,du.section=du_section,du.repeat=du_repeat,du.opt=du_opt,du.div=du_div,du.layout=du_layout,du.mount=du_mount;const mounted_prefix_comment="\x3c!-- Durium.js: mounted component --\x3e";function mount_durium_component(t,e){let i=t(),n=document.createElement("div");n.setAttribute("class","du_genApplication"),e.appendChild(n),n.innerHTML=`${mounted_prefix_comment}${i.toHtml()}`,Object.entries(LayoutNode.loaded_stations).forEach((([t,e])=>{e._fire()})),LayoutNode.loaded_stations={}}export function du_f_(t){Station.reg[t]._fire()}export function du_fe_(t,e){let i=Station.reg[t],n=document.getElementById(e);i._fire(n)}
